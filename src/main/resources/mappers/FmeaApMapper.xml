<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.rb.fmea.dao.FmeaApMapper" >
  <resultMap id="BaseResultMap" type="com.rb.fmea.entities.FmeaAp" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    <id column="id" property="id" jdbcType="INTEGER" />
    <result column="ap_value" property="apValue" jdbcType="VARCHAR" />
      <result column="opt_ap_value" property="optApValue" jdbcType="VARCHAR" />
    <result column="fail_analysis_id" property="failAnalysisId" jdbcType="INTEGER" />
    <result column="detection_degree" property="detectionDegree" jdbcType="INTEGER" />
    <result column="frequency_degree" property="frequencyDegree" jdbcType="INTEGER" />
      <result column="opt_detection_degree" property="optDetectionDegree" jdbcType="INTEGER" />
      <result column="opt_frequency_degree" property="optFrequencyDegree" jdbcType="INTEGER" />
    <result column="severity" property="severity" jdbcType="INTEGER" />
  </resultMap>
  <delete id="deleteByPrimaryKey" parameterType="java.lang.Integer" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    delete from fmea_ap
    where id = #{id,jdbcType=INTEGER}
  </delete>
  <insert id="insert" parameterType="com.rb.fmea.entities.FmeaAp" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    <selectKey resultType="java.lang.Integer" keyProperty="id" order="AFTER" >
      SELECT LAST_INSERT_ROWID()
    </selectKey>
    insert into fmea_ap (ap_value, fail_analysis_id, detection_degree, 
      frequency_degree, opt_detection_degree,opt_frequency_degree,opt_ap_value,severity)
    values (#{apValue,jdbcType=VARCHAR}, #{failAnalysisId,jdbcType=INTEGER}, #{detectionDegree,jdbcType=INTEGER},
      #{frequencyDegree,jdbcType=INTEGER},#{optDetectionDegree,jdbcType=INTEGER},#{optFrequencyDegree,jdbcType=INTEGER},#{optApValue,jdbcType=VARCHAR}, #{severity,jdbcType=INTEGER})
  </insert>
  <update id="updateByPrimaryKey" parameterType="com.rb.fmea.entities.FmeaAp" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    update fmea_ap
    set ap_value = #{apValue,jdbcType=VARCHAR},
      fail_analysis_id = #{failAnalysisId,jdbcType=INTEGER},
      detection_degree = #{detectionDegree,jdbcType=INTEGER},
      frequency_degree = #{frequencyDegree,jdbcType=INTEGER},
      opt_detection_degree = #{optDetectionDegree,jdbcType=INTEGER},
      opt_frequency_degree = #{optFrequencyDegree,jdbcType=INTEGER},
      opt_ap_value = #{optApValue,jdbcType=VARCHAR},
      severity = #{severity,jdbcType=INTEGER}
    where id = #{id,jdbcType=INTEGER}
  </update>
  <select id="selectByPrimaryKey" resultMap="BaseResultMap" parameterType="java.lang.Integer" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    select id, ap_value, fail_analysis_id, detection_degree, frequency_degree, opt_detection_degree,opt_frequency_degree,opt_ap_value,severity
    from fmea_ap
    where id = #{id,jdbcType=INTEGER}
  </select>
  <select id="selectAll" resultMap="BaseResultMap" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    select id, ap_value, fail_analysis_id, detection_degree, frequency_degree, opt_detection_degree,opt_frequency_degree,opt_ap_value,severity
    from fmea_ap
  </select>



    <!--根据失效分析id查询-->
    <select id="selectFailAnalysisId" resultMap="BaseResultMap" >
        select id, ap_value, fail_analysis_id, detection_degree, frequency_degree, opt_detection_degree,opt_frequency_degree,opt_ap_value,severity
        from fmea_ap where fail_analysis_id=#{failAnalysisId}
    </select>


    <!--根据失效分析id更新ap值-->
    <update id="updateByFailAnalysisId" parameterType="com.rb.fmea.entities.FmeaAp" >
        update fmea_ap
        set ap_value = #{apValue},frequency_degree=#{frequencyDegree},detection_degree=#{detectionDegree}
        where fail_analysis_id = #{failAnalysisId}
    </update>


    <!--根据失效分析id更新优化后的ap值-->
    <update id="updateProtyByFailAnalysisId" parameterType="com.rb.fmea.entities.FmeaAp" >
        update fmea_ap
        set ap_value = #{apPriorityValue},frequency_degree=#{optFrequencyDegree},detection_degree=#{optDetectionDegree}
        where fail_analysis_id = #{failAnalysisId}
    </update>


    <!--根据fmeaid查询高风险fmea-->
    <select id="selectApValueByFmeaId" resultType="com.rb.fmea.dto.ApHvalueDto">
         select p.structure_name part,f.structure_name feature,ffa.analysis_standard failAnalysis ,fa.ap_value apValue from (
       select id,structure_name from fmea_structure where superior_id
       in (select id from fmea_structure where superior_id
       in(select id from fmea_structure where fmea_id=#{fmeaId} and superior_id=0))
       ) p left outer join fmea_structure f on p.id=f.superior_id left outer join fmea_function ff on f.id = ff.fmea_structure_id
       left outer join fmea_fail_analysis ffa on ffa.function_id=ff.id left outer join fmea_ap fa on ffa.id=fa.fail_analysis_id where fa.ap_value="H" limit #{limit} offset #{page}

    </select>

    <!--查询高风险的总条数-->
    <select id="count" resultType="java.lang.Integer">
         select count(fa.id) from (
       select id,structure_name from fmea_structure where superior_id
       in (select id from fmea_structure where superior_id
       in(select id from fmea_structure where fmea_id=#{fmeaId} and superior_id=0))
       ) p left outer join fmea_structure f on p.id=f.superior_id left outer join fmea_function ff on f.id = ff.fmea_structure_id
       left outer join fmea_fail_analysis ffa on ffa.function_id=ff.id left outer join fmea_ap fa on ffa.id=fa.fail_analysis_id where fa.ap_value="H"

    </select>


    <!--查询一个fmea下的所有失效分析-->
    <!--<select id="selectFailAnalysisByFmeaId" resultMap="com.rb.fmea.dto.ApHvalueDto">
        select o.part,o.feature,ffa.analysis_standard failAnalysis from fmea_fail_analysis ffa left outer join (
        select p.part,p.feature,ff.id from fmea_function ff left outer join (
       select m.structure_name part,m.structure_name feature,m.id from fmea_structure fs left outer join (
        select id,structure_name from fmea_structure where superior_id
       in (select id from fmea_structure where superior_id
       in(select id from fmea_structure where fmea_id=#{fmeaId} and superior_id=0))
       )m on fs.superior_id=m.id) p on ff.fmea_structure_id=p.id) o on o.id=ffa.function_id
    </select>-->

</mapper>